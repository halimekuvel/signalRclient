<!DOCTYPE html>
<html>
  <head>
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.4.20/sweetalert2.css"
      referrerpolicy="no-referrer"
    />

    <title>Let's chat!</title>
  </head>
  <style>
    .overflow2-auto {
      height: 350px;
      overflow-y: scroll;
    }
  </style>

  <body>
    <div
      class="alert alert-info"
      role="alert"
      id="status"
      style="display: none"
    ></div>

    <div style="background-color: black; color: white" id="connectionId"></div>
    <br />
    <div class="container">
      <div class="row">
        <div class="col-md-4 border">
          <br />
          <h3>Username:</h3>
          <input
            type="text"
            id="userName"
            class="form-control"
            placeholder="Your Username"
          />
          <br />
          <button id="confirmUserName" class="btn btn-primary mt-1">
            Confirm
          </button>
          <br /><br /><br />
          <div id="helloUser"></div>
          <br /><br />
          <h5>Online Users</h5>
          <br />
          <div id="clients" class="ml-1 pb-4"></div>
        </div>
        <div class="col-md-4 border">
          <br />
          <h3>Chat with Everyone!</h3>
          <br />
          <input
            type="text"
            id="txtMessage"
            class="form-control"
            placeholder="Message"
          />
          <br />
          <button id="btnSend" class="btn btn-primary mt-1" disabled>
            Send
          </button>
          <br /><br />
          <div class="container overflow2-auto">
            <div id="showMessages"></div>
          </div>
        </div>
        <div class="col-md-4 border">
          <br />
          <h3>Group Chat</h3>
          <br />
          Add a new group:
          <br />
          <input
            type="text"
            id="groupName"
            class="form-control"
            placeholder="Enter Group Name"
            required
          />
          <button id="btnAddGroup" class="btn btn-primary mt-1" disabled>
            Add Group
          </button>
          <br />
          <div id="noMoreGroupWarning"></div>
          <br />

          Select a group to join:
          <br /><br />
          <div
            class="btn-group btn-group-toggle chosenGroup table"
            style="max-width: 100%; display: block"
            data-toggle="buttons"
            id="selectGroup"
          ></div>
          <!-- Button trigger modal -->
          <button
            type="button"
            class="btn btn-primary"
            id="modalButton"
            data-toggle="modal"
            data-target="#modalGroupChat"
            style="display: none"
          >
            Open Chat
          </button>

          <!-- Modal -->
          <div
            class="modal fade"
            id="modalGroupChat"
            tabindex="-1"
            role="dialog"
            aria-labelledby="currentGroupName"
            aria-hidden="true"
          >
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="currentGroupName">Chat Box</h5>

                  <button
                    type="button"
                    class="close"
                    id="closeGroupModal"
                    data-dismiss="modal"
                    aria-label="Close"
                  >
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <div id="groupMsgAccess" style="display: none">
                    <button
                      type="button"
                      class="btn btn-primary mt-1"
                      data-dismiss="modal"
                      aria-label="Close"
                      id="btnLeaveGroup"
                    >
                      Leave Group
                    </button>
                    <div id="currentGroupInfo"></div>
                    <div id="currentGroupName"></div>
                    <div class="container overflow2-auto">
                      <div id="showGroupMessages"></div>
                    </div>
                  </div>
                </div>
                <input
                  type="text"
                  id="txtMessageGroup"
                  class="form-control"
                  placeholder="Message"
                />
                <br />
                <button id="btnSendGroup" class="btn btn-primary mt-1">
                  Send
                </button>
              </div>
            </div>
          </div>
          <button id="btnJoinGroup" class="btn btn-primary mt-2" disabled>
            Join Group
          </button>
          <br /><br />
          <br /><br />
        </div>
      </div>
    </div>
    <script src="signalr.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="jquery.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.4.20/sweetalert2.js"
      referrerpolicy="no-referrer"
    ></script>
    <script>
      // determine the hub that the client will connect to with webSocket
      $(document).ready(() => {
        const connection = new signalR.HubConnectionBuilder()
          .withUrl("http://localhost:5001/myhub")
          .withAutomaticReconnect([1000, 1000, 2000, 5000]) // used when disconnected - parameters are ms
          .build();
        // if the client couldn't connect to the server these functions will be used
        async function start() {
          try {
            await connection.start();
          } catch (error) {
            setTimeout(() => start(), 2000);
          }
        }

        start();

        function animation() {
          status.fadeIn(2000, () => {
            setTimeout(() => {
              status.fadeOut(2000);
            }, 2000);
          });
        }

        const status = $("#status");
        currAlertClass = "alert alert-info"; // holds the current alert's class
        // this event awakes while trying to reconnect to the server
        connection.onreconnecting((error) => {
          // status.css("background-color", "blue");
          // status.css("color", "white");
          status.removeClass(currAlertClass);
          status.addClass("alert alert-warning");
          currAlertClass = "alert alert-warning";
          status.html("Connecting...");
          animation();
        });

        // this event awakes when reconnected to the server
        connection.onreconnected((connectionId) => {
          status.removeClass(currAlertClass);
          status.addClass("alert alert-success");
          currAlertClass = "alert alert-success";
          status.html("Connected!");
          animation();
        });

        // this event awakes if client couldn't reconnect to the server after trying few times
        connection.onclose((error) => {
          status.removeClass(currAlertClass);
          status.addClass("alert alert-danger");
          currAlertClass = "alert alert-danger";
          status.html("Connection failed.");
          animation();
        });

        // server will notify the clients through this event when a user joined
        connection.on("userJoined", (connectionName) => {
          status.removeClass(currAlertClass);
          status.addClass("alert alert-success");
          currAlertClass = "alert alert-success";
          if (configureLoginFields(connectionName)) {
            status.html(`${connectionName} joined.`);
            animation();
          }
          // After login, username text should be disabled
          $("#userName").prop("disabled", true);
        });

        // server will notify the clients through this event when a user left

        connection.on("userLeft", (connectionId) => {
          status.removeClass(currAlertClass);
          status.addClass("alert alert-danger");
          currAlertClass = "alert alert-danger";
          status.html(`${connectionId} left.`);
          animation();
        });

        // write the online clients list to the screen
        connection.on("clients", (userNames) => {
          let userNamesTxt = "";
          $.each(userNames, (index, item) => {
            userNamesTxt += `<li class="list-group-item">${item}</li>`;
          });
          $("#clients").html(userNamesTxt);
        });

        let connectionId_ = "";
        // send the client's message to the SendMessageAsync method in the server
        $("#btnSend").click(() => {
          let message = $("#txtMessage").val();
          //let connectionIds = $("#connectionIds").val().split(",");
          //Resetting input fields after message is sent
          $("#txtMessage").val("");
          $("#txtMessage").removeClass("is-invalid");

          // send to group chosen with radio buttons
          //connection.invoke("SendMessageAsync", message, $("input[name=group]:checked").val()).catch(error => console.log(`Error occured while sending a message. ${error}`));

          // send to clients with specified connectionIds
          //connection.invoke("SendMessageAsync", message, connectionIds).catch(error => console.log(`Error occured while sending a message. ${error}`));

          // send All, Caller, Others
          connection
            .invoke("SendMessageAsync", message)
            .catch((error) =>
              console.log(`Error occured while sending a message. ${error}`)
            );
        });
        // enter key to send the message
        $("#txtMessage").keypress(function (e) {
          if (e.which == 13) {
            $("#btnSend").click();
          }
        });

        // take the message that have been send from the server with the RPC system
        connection.on("receiveMessage", (message, connectionId, userName) => {
          floatType = "";
          classType = "";
          userNameText = "";
          if (connectionId === connectionId_) {
            floatType = "right";
            classType = "warning";
            userNameText = "";
          } else {
            floatType = "left";
            classType = "light";
            userNameText =
              "<strong>" + userName + " </strong> <br><div class = 'mt-2'>";
          }
          let nameAndMsg =
            '<span class="badge badge-' +
            classType +
            " float-" +
            floatType +
            '"> ' +
            userNameText +
            message +
            "</div></span><br><br>";

          $("#showMessages").append(nameAndMsg);
        });

        $("#btnSendGroup").click(() => {
          let message = $("#txtMessageGroup").val();
          //let connectionIds = $("#connectionIds").val().split(",");
          $("#txtMessageGroup").val("");
          $("#txtMessageGroup").removeClass("is-invalid");
          // send to group chosen with radio buttons
          connection
            .invoke("SendMessageToGroupAsync", message, currentGroupName)
            .catch((error) =>
              console.log(
                `Error occured while sending a group message. ${error}`
              )
            );
        });
        // enter key to send the message
        $("#txtMessageGroup").keypress(function (e) {
          if (e.which == 13) {
            $("#btnSendGroup").click();
          }
        });

        // receive message for the selectGoups
        connection.on("receiveGroupMessage", (resp) => {
          let response = JSON.parse(resp);

          if (response.groupName == currentGroupName)
            // print the message
            printGroupMessage(response);
          else {
            // notification

            Swal.fire({
              position: "bottom-end",
              title: "Group " + response.groupName,
              text: response.sender + ": " + response.message,
              backdrop: false,
              showConfirmButton: true,
              timer: 3500,
              width: "20em",
            });

            if (!$(".chosenGroup #" + response.groupName).hasClass(".bi"))
              $(".chosenGroup #" + response.groupName).append(
                '  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bell-fill" viewBox="0 0 16 16"><path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zm.995-14.901a1 1 0 1 0-1.99 0A5.002 5.002 0 0 0 3 6c0 1.098-.5 6-2 7h14c-1.5-1-2-5.902-2-7 0-2.42-1.72-4.44-4.005-4.901z"/></svg>'
              );
          }
        });

        function printGroupMessage(response) {
          if (response.groupName == $("input[name=group]:checked").val()) {
            floatType = "";
            classType = "";
            if (response.connectionId === connectionId_) {
              floatType = "right";
              classType = "warning";
            } else {
              floatType = "left";
              classType = "light";
            }
            let nameAndMsg =
              '<span class="badge badge-' +
              classType +
              " float-" +
              floatType +
              '">' +
              "<strong>" +
              response.sender +
              " : </strong>" +
              response.message +
              "</span><br><br>";
            $("#showGroupMessages").append(nameAndMsg);
          }
        }

        // write the connectionId of the client
        connection.on("getConnectionId", (connectionId) => {
          connectionId_ = connectionId;
          // $("#connectionId").html(`Your Connection ID: ${connectionId}`);
        });

        let currentGroupName = "";
        $("#btnJoinGroup").click(() => {
          currentGroupName = $("input[name=group]:checked").val();
          connection
            .invoke("JoinGroup", connectionId_, currentGroupName)
            .catch((error) =>
              console.log(`Error occured while joining a group. ${error}`)
            );
          // remove style display:none
          $("#groupMsgAccess").removeAttr("style");
          $("#btnJoinGroup").css("display", "none"); // hide join button
        });
        $("#btnLeaveGroup").click(() => {
          connection
            .invoke("LeaveGroup", connectionId_, currentGroupName)
            .catch((error) =>
              console.log(`Error occured while leaving a group. ${error}`)
            );
          // add style display:none
          $("#groupMsgAccess").attr("style", "display:none");
          // click leavegroup button activate the close group modal button
          $("#closeGroupModal").click();
        });

        connection.on("checkJoinGroup", (groupResponse) => {
          groupResponse_ = JSON.parse(groupResponse);
          // user joined
          if (groupResponse_.ClienInGroup) {
            $("#currentGroupInfo").html(
              "You joined Group " + currentGroupName + " Chat!"
            );
            $("#currentGroupInfo").fadeIn(2000, () => {
              setTimeout(() => {
                $("#currentGroupInfo").fadeOut(2000);
              }, 2000);
            });
            $("#currentGroupName").html("Group " + currentGroupName + " Chat:");
            // change button color, deactivate and uncheck the group button
            $(".chosenGroup .active").attr("class", "btn btn-success");
            $("input[name=group]:checked").prop("checked", false);
            currentGroupName = "";
          } else {
            // user already in group
            $("#currentGroupInfo").html(
              "You have already joined Group " + currentGroupName + " Chat!"
            );
            $("#currentGroupInfo").fadeIn(2000, () => {
              setTimeout(() => {
                $("#currentGroupInfo").fadeOut(2000);
              }, 2000);
            });
          }
        });
        connection.on("checkLeaveGroup", () => {
          $(".chosenGroup .active").attr("class", "btn btn-secondary active");
        });

        connection.on("notificationJoinGroup", (userName) => {
          // user joined
          if (userName != localStorage.getItem("userName_")) {
            $("#currentGroupInfo").html(
              userName + " joined Group " + currentGroupName + " Chat!"
            );
            $("#currentGroupInfo").fadeIn(2000, () => {
              setTimeout(() => {
                $("#currentGroupInfo").fadeOut(2000);
              }, 2000);
            });
          }
        });

        $("#btnAddGroup").click(() => {
          if ($("#groupName").val() == "") {
            $("#groupName").addClass("is-invalid");
            setTimeout(() => {
              alert("Group name is required!");
            }, 200);
          } else {
            let groupName = $("#groupName").val();
            connection
              .invoke("AddGroup", connectionId_, groupName)
              .catch((error) =>
                console.log(`Error occured while adding a group. ${error}`)
              );
          }
          $("#groupName").val("");
          $("#groupName").removeClass("is-invalid");
        });

        // enter key to send the message
        $("#groupName").keypress(function (e) {
          if (e.which == 13) {
            $("#btnAddGroup").click();
          }
        });
        connection.on("groupLimitReached", () => {
          $("#groupName").prop("disabled", true);
          $("#btnAddGroup").prop("disabled", true);
          $("#noMoreGroupWarning").html(
            "You have reached the maximum number of groups! (Maximum 6 groups)"
          );
          $("#noMoreGroupWarning").fadeIn(2000, () => {
            setTimeout(() => {
              $("#noMoreGroupWarning").fadeOut(2000);
            }, 2000);
          });
        });

        connection.on("updateGroups", (groupNames) => {
          $("#selectGroup").empty();
          $.each(groupNames, (index, item) => {
            let grpName = `${item}`;
            $("#selectGroup").append(
              $("<label>")
                .prop({
                  class: "btn btn-secondary",
                  style:
                    "overflow: hidden;text-overflow: ellipsis;max-width: 100%;",
                  id: grpName,
                })
                .append(
                  $("<input>").prop({
                    type: "radio",
                    name: "group",
                    autocomplete: "off",
                    value: grpName,
                  })
                )
                .append(grpName)
            );
          });
        });
        connection.on("checkUserName", (userName) => {
          $("#userName").addClass("is-invalid");
          setTimeout(() => {
            alert(
              "This username already taken! Please enter another username."
            );
          }, 200);
          setTimeout(() => {
            $("#userName").removeClass("is-invalid");
          }, 200);
          $("#userName").val("");
        });

        // add a new group to radio button if it doesn't already exist
        connection.on(
          "checkAddGroup",
          (groupAlreadyExists, groupName, connectionId) => {
            className = "";
            if (connectionId == connectionId_) {
              className = "btn btn-success ml-1 mb-1";

              $("#groupMsgAccess").removeAttr("style"); // show group chat box
              $("#btnJoinGroup").css("display", "none"); // hide join button
              // deactivate and uncheck the group button
              $(".chosenGroup .active").attr("class", "btn btn-success");
              $("input[name=group]:checked").prop("checked", false);
            } else className = "btn btn-secondary ml-1 mb-1";
            if (groupAlreadyExists == false) {
              $("#selectGroup").append(
                $("<label>")
                  .prop({
                    class: className,
                    style:
                      "overflow: hidden;text-overflow: ellipsis;max-width: 100%;",
                    id: groupName,
                  })
                  .append(
                    $("<input>").prop({
                      type: "radio",
                      name: "group",
                      autocomplete: "off",
                      value: groupName,
                      checked: true,
                    })
                  )
                  .append(groupName)
              );
            } else if (connectionId === connectionId_) {
              $("#noMoreGroupWarning").html("This group name is taken!");
              $("#noMoreGroupWarning").fadeIn(2000, () => {
                setTimeout(() => {
                  $("#noMoreGroupWarning").fadeOut(2000);
                }, 2000);
              });
            }
          }
        );

        $("#groupName").click(() => {
          $("#groupName").removeClass("is-invalid");
        });

        $("#closeGroupModal").click(() => {
          $(".chosenGroup .active").removeClass("active");
          $("input[name=group]:checked").prop("checked", false);
          currentGroupName = "";
        });
        // $("#modalGroupChat").on("hidden.bs.modal", function () {
        //   console.log("Modal kapatıldı");
        // });

        // add username
        $("#confirmUserName").click(() => {
          let userName = $("#userName").val();
          localStorage.setItem("connectionId_", connectionId_);
          localStorage.setItem("userName_", userName);
          // send the username and connectionId to the server
          connection
            .invoke("AddUserName", userName, connectionId_)
            .catch((error) =>
              console.log(`Error occured while adding a username. ${error}`)
            );
        });
        // enter key to send the message
        $("#userName").keypress(function (e) {
          if (e.which == 13) {
            $("#confirmUserName").click();
          }
        });

        // when the chosen group has changed
        document.querySelector(".chosenGroup").addEventListener("click", () => {
          setTimeout(() => {
            let selectedBtn = $(
              ".chosenGroup label input[name='group']:checked"
            );

            // if other than a button selected return
            if (selectedBtn.val() == null) return;

            // if a different group has been selected
            if (selectedBtn.val() != currentGroupName) {
              $("#showGroupMessages").empty();
              // if user not in that group
              if (selectedBtn.parent().hasClass("btn-secondary")) {
                $("#groupMsgAccess").css("display", "none"); // hide chat box
                $("#btnJoinGroup").removeAttr("style"); // show join group button
              } else {
                // if user is also in that group
                $("#groupMsgAccess").removeAttr("style"); // show chat box
                $("#btnJoinGroup").css("display", "none"); // hide join button
                $("#btnLeaveGroup").removeAttr("style");

                // open modal chat box
                $("#modalButton").click();

                // remove notification bell if there were any notifications
                $(".chosenGroup #" + selectedBtn.val() + " .bi").remove();

                // get previous messages from server
                $("#currentGroupName").html(
                  "Group " + selectedBtn.val() + " Chat:"
                );
                connection
                  .invoke("GetPrevGroupMsgs", selectedBtn.val())
                  .catch((error) =>
                    console.log(
                      `Error occured while loading previous group messages. ${error}`
                    )
                  );
              }
            } else {
              if (!selectedBtn.parent().hasClass("btn-secondary")) {
                $("#modalButton").click();
              } else {
                $("#groupMsgAccess").css("display", "none"); // hide chat box
                $("#btnJoinGroup").removeAttr("style"); // show join group button
              }
            }
            // update currentGroupName value
            currentGroupName = selectedBtn.val();
          }, 1);
        });

        connection.on("receivePrevGroupMsgs", (messages) => {
          let messages_ = JSON.parse(messages);
          $.each(messages_, (index, item) => {
            printGroupMessage(item);
          });
        });

        function configureLoginFields(userName) {
          if (userName) {
            $("#helloUser").html("Hi " + userName + "!");
            $("#confirmUserName").prop("disabled", true);
            $("#btnSend").prop("disabled", false);
            $("#btnJoinGroup").prop("disabled", false);
            $("#btnLeaveGroup").prop("disabled", false);
            $("#btnAddGroup").prop("disabled", false);
            return true;
          }
          return false;
        }
      });
    </script>
  </body>
</html>
